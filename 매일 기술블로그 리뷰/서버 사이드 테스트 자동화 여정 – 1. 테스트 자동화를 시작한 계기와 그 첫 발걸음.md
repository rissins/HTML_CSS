# 매일 기술블로그 Review

# 2021-10-29

### / 링크

[서버 사이드 테스트 자동화 여정 - 1. 테스트 자동화를 시작한 계기와 그 첫 발걸음 - LINE ENGINEERING](https://engineering.linecorp.com/ko/blog/server-side-test-automation-journey-1/)

### / 정리

 개발을 할 때 효율적인 코드, 객체 지향 등 여러가지 지켜야 할 점이있다. 근데 그 중에서도 오류가 생기는 확인하는 테스트코드가 당연 중요시해야 한다고 생각한다. 나는 아직 겪어보지 못했지만 큰 규모의 상황이 되면 개발보다 테스트 코드 작성하는데 더 많은 시간을 들이는 경우도 있다고 한다. 그래서 당장은 시간이 걸리더라도 장기적으로 보면 테스트를 자동화하면 테스트에 들어가는 비용이 줄고 더 빠르고 안전한 개발을 목표로 한다. 

 

### 첫 테스트 자동화 결과

 실패한 테스트가 존재한다면 배포할 수 없도록 하는 건 빌드 파일의 기능적 안정성은 보장할 수 있었다. 하지만 개발이나 테스트 환경에 배포하는 중에 실패한 테스트가 나타나면 배포가 중단되면서 업무 진행 속도를 심각하게 저하시켰다. 배포가 중단된 사례 중 테스트 코드가 잘못 작성된 게 원인일 때 오히려 개발에 시간을 낭비하게 되어 정책을 유지하기 어려웠다. 

### 해결방안?

 '코드 리뷰 단계'에서 배포 가능 여부가 확인 될 수 있다면 생각으로 Jenkis의 'GitHub pull request builder'라는 플러그인으로 가능성이 열렸다. 이 플러그인을 이용하여 테스트 실행 결과를 코드 리뷰 단계에서 확인, 배포 가능 여부를 미리 알 수 있도록 했다. 

![testauto1-1.png](https://github.com/rissins/study/blob/master/%EC%9E%90%EB%B0%94%EA%B3%A0%EA%B8%89%EC%8A%A4%ED%84%B0%EB%94%94/images/testauto1-1.png)

테스트가 성공한 경우

![testauto1-2.png](https://github.com/rissins/study/blob/master/%EC%9E%90%EB%B0%94%EA%B3%A0%EA%B8%89%EC%8A%A4%ED%84%B0%EB%94%94/images/testauto1-2.png)

테스트가 실패한 경우

 결과로 배포가 중단되는 문제가 발생하지 않게 하면서도 '실패하는 테스트 케이스가 존재하면 배포를 중단해야 한다'라는 정책을 가능하게 했다.

- 또 다른 이점들
    1. 작업자가 코드 변경 사항에 대한 피드백을 이전보다 빠르게 받을 수 있게 되었다.
    2. 코드 리뷰에 참여하는 동료 개발자들이 코드 리뷰를 시작하기 전에 해당 변경 사항의 동작 가능 여부를 확인할 수 있게 되었다.
    3. 테스트 실행 결과가 PR(Pull Request) 페이지에 나타나면서 개발자들이 자연스럽게 테스트에 더 많은 관심을 갖게 되었다.
    

### 설정 테스트 추가 및 자동화

 테스트가 모두 성공했는데도 배포를 했을 때 서버 모듈이 제대로 기동되지 않는 문제가 발생했다. 그 이유는 모듈을 구성하는 설정을 정상적으로 로딩하지 못하는 게 원인인 경우가 대부분이였다. 심각한 문제가 아닌 것같지만 미디어 플랫폼에선 설정 오류가 매우 심각한 문제에 해당했다.

 이 문제는 설정 객체를 조립하 단위 테스트를 작성하고 이를 배포 환경별로 빌드하여 테스트를 실행하도록 구성함으로써 해결할 수 있었다. 하지만 전체 코드가 배포 환경별로 매번 실행되어 Jenkins 서버 자원이 부족해지는 문제가 발생했다. 이를 빌드 도구인 Maven의 플러그인에서 특정 단위 테스트만 실행시키는 기능을 제공하고 있어서 이를 이용하여 Jenkins 서버 자원을 많이 사용하지 않고도 배포 환경별로 설정 개체가 정상적으로 로딩될 수 있는지 확인할 수 있엇다.

### 성능 테스트 자동화

 모든 테스트가 통과했는데도 개발과 테스트 환경에 새로운 버전의 서버 모듈을 투입했을 때 모든 요청 처리가 실패하거나 성능이 기대치보다 떨어지는 문제들이 발생했었다. 이 문제는 테스트 전용서버에 테스트 대상이 되는 서버 모듈을 배포하고 테스트용 트래픽만 생성할 수 있다면 어렵지 않게 해결할 수 있을까 생각했다. 그 결과 PR이 생성되면 성능 테스트 대상이 되는 코드를 배포하고, 성능 테스트를 수행했다. 성능 테스트 실행 결과로 생성되는 테스트 대상 서버의 시스템 지표 역시 코드 리뷰 단계에서 확인할 수 있도록 성능 테스트 결과가 PR의 댓글로 달리도록 구성했다. 

### 피드백을 더 빨리 전달

 테스트 수행 결과가 빨리 제공되지 않아 PR을 머지하지 못하고 그에 따라 개발이나 테스트 환경에 빨리 배포해 보지 못하는 상황이 발생했다. 문제는 Jenkins 서버여서 Jenkins는 이런 상황에서 활용 할 수 있는 노드 추가 기능을 제공했다. Jenkins에 슬레이브 노드를 추가하면 컴퓨팅 파워를 선형적으로 늘리 수 있었다.

### 첫 자동화의 결과

 테스트를 자동화하면서 테스트 작업이 정형화되고, 반복 업무와 실수가 많이 줄어들면서 테스트 업무에 할당하는 시간을 많이 줄일 수 있었으며, 무엇보다 이전보다 훨씬 많은 테스트 작업을 수행하면서도 결과 확인까지 10분이 채 걸리지 않아 생산성 향상에 큰 도움이 되었다.